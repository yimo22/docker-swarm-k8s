
#### [6.5.0.0] 서비스(Service) : 파드를 연결하고 외부에 노출
파드의 IP는 영속적이지 않아 항상 변할 수 있다는 점을 유의해야 한다. 여러 개의 Deployment 를 하나의 완벽한 애플리케이션으로 연동하려면 파드 IP가 아닌, 서로를 발견 (Discovery) 할 수 있는 다른 방법이 필요하다.

deployment 에서 파드의 노출은 `containerPort` 항목을 통해서 노출한다. 하지만 이를 정의했다고 해서 이 파드가 바로 외부로 노출되는 것은 아니다.

다른 Deployment 의 파드들이 내부적으로 접근하려면 `서비스(Service)` 라고 부르는 별도의 쿠버네티스 오브젝트를 생성해야 한다. 서비스는 파드에 대한 접근하기 위한 규칙을 정의하며, 다음과 같은 특징을 갖는다.
- 여러 개의 파드에 쉽게 접근할 수 있도록 고유한 도메인 이름을 부여
- 여러 개의 파드에 접근할 때, 요청을 분산하는 로드 밸런서 기능을 수행
- 클라우드 플랫폼의 로드밸런서, 클러스터 노드의 포트 등을 통해 파드를 외부로 노출

> k8s 를 설치할 때 calico, flannel 등 네트워크 플러그인을 사용하도록 설정한다. (자동으로 overlay network를 통해서 각 파드끼리 통신할 수 있다.) 단, 어떤 네트워크 플러그인을 사용하느냐에 따라서 네트워킹 기능 및 성능에 차이가 있을 수 있다.

#### [6.5.1.0] 서비스의 종류
k8s 의 서비스는 파드에 어떻게 접근할 것이냐에 따라 종류가 여러 개로 세분화돼 있다. 따라서 목적에 맞는 적절한 서비스의 종류를 선택해야 한다.

- Cluster IP 타입
  - 쿠버네티스 내부에서만 파드들에 접근할 때 사용
  - 외부로 파드를 노출하지 않기 때문에 쿠버네티스 클러스터 내부에서만 사용되는 파드에 적합
- NodePort 타입
  - 파드에 접근할 수 있는 포트를 클러스터의 모든 노드에 동일하게 개방
  - 접근할 수 있는 포트는 랜덤으로 정해지지만, 특정 포트로 접근하도록 설정할 수도 있다.
- LoadBalancer 타입
  - 클라우드 플랫폼에서 제공하는 로드 밸런서를 동적으로 프로비저닝해 파드에 연결
  - Node Port 타입과 마찬가지로 외부에서 파드에 접근 가능
  - AWS, GCP 등과 같은 클라우드 플랫폼 환경에서만 사용할 수 있음

#### [6.5.2.0] ClusterIP 타입의 서비스 - 쿠버네티스 내부에서만 파드에 접근하기

`hostname-svc-clusterip.yml` 적용
 
> `spec.selector` 항목은 이 서비스에서 어떤 라벨을 가지는 파드에 접근할 수 있게 만들 것인지 결정
> 
> `spec.ports.port` k8s 내부에 할당받은 고유IP에 대하여 접근할 때 사용할 포트를 설정
>
> `spec.ports.targetPort` selector 항목에서 정의한 라벨에 의해 접근 대상이 된 파드들이 내부적으로 사용하고 있는 포트를 입력. 즉, 파드 템플릿에 정의된 containerPort와 같은 값으로 설정해야 한다
>
> `spec.type` 는 이 서비스가 어떤 타입인지 나타낸다.

> k8s 에서의 라벨은 단순히 리소스의 부가적인 정보를 표시하는 것 이상의 기능을 가질 수 있다.

> service를 생성하지 않아도, 기본적으로 `kubernetes` 라는 서비스가 생성되어 있다.

이후에 해당 IP+PORT 또는 SERVICE_NAME 으로 접근할 경우 접근이 가능하다. 또한 서비스를 생성할 때 별도의 설정을 하지 않아도 서비스는 연결된 파드에 대해 로드 밸런싱을 수행한다.


<u><b><i>Cluster IP 타입의 서비스를 생성해 파드에 접근하는 과정</i></b></u>
1. 특정 라벨을 가지는 파드를 서비스와 연결하기 위해 서비스의 yml 파일에 selector 항목을 정의
2. 파드에 접근할 때 사용하는 포트를 yml 파일의 targetPort 항목에 정의
3. 서비스를 생성할 때, yml 파일의 port 항목에 8080을 명시해 서비스의 Cluster IP 와 8080 포트로 접근할 수 있도록 설정
4. kubectl apply 로 ClusterIP 타입의 서비스 적용
5. k8s 클러스터에서 서비스의 내부 IP 또는 서비스 이름으로 접근 가능

이는 ClusterIP 타입이기 때문에 외부에서 접근이 불가능하다. 외부에 노출해야 한다면 NodePort나 LoadBalancer 타입의 서비스를 생성해야 한다.

> 서비스의 Label Selector 와 파드의 라벨이 매칭돼 연결되면, k8s는 자동으로 `엔드포인트` 라고 부르는 오브젝트를 별도로 생성. 이때 이름은 서비스와 동일하다
>
> `kubectl get endpoints` 로 확인 가능

#### [6.5.3.0] NodePort 타입의 서비스 - 서비스를 이용해 파드를 외부에 노출하기

`hostname-svc-nodeport.yml` 적용

해당 파일을 적용 후, `kubectl get no -o wide` 를 통해서 `INTERNAL-IP` 와 `EXTERNAL-IP`를 확인할 수 있다.

> 각 노드에서 개방되는 포트는 기본적으로 30000~32768 포트 중에 랜덤으로 선택되지만, yml 파일에 nodePort 항목을 통해서 원하는 포트를 설정할 수 있다.
> ``` yml
> spec:
>   ports:
>   - name: web-port
>     port: 8080
>     targetPort: 80
>     nodePort: 31000
> ```
> 또한 `--service-node-port-range=1234~5678` 을 통해서 포트범위 설정도 가능하다. (30000 이상의 포트 설정 권장)


- NodePort 타입의 서비스가 ClusterIP 의 기능을 포함하고 있다.
  - CLUSTER-IP 항목에 내부 IP가 할당된다.
  - k8s 내/외부 에서 접근이 가능하다

- 실제 운영환경에서는 NortPort 를 외부에 제공하는 경우는 많지 않다.
  - SSL or 라우팅 등의 복잡한 설정을 서비스에 적용하기가 힘들다.
  - 직접 제공보다는 인그레스(Ingress) 라는 k8s의 오브젝트에서 간접적으로 사용되는 경우가 많다.

> 특정 클라이언트가 같은 파드로부터만 처리되게 하려면 서비스의 yml 파일에서 sessionAffinity 항목을 ClientIP로 설정한다.
> ``` yml
> spec:
>   sessionAffinity: ClientIP
> ```

#### [6.5.4.0] 클라우드 플랫폼의 로드 밸런서와 연동하기 - LoadBalancer 타입의 서비스
LoadBalancer 타입의 서비스는 클라우드 플랫폼으로부터 도메인 이름과 IP를 할당받기 때문에 더 쉽게 파드에 접근가능. 

하지만 LoadBalancer 타입의 서비스는 로드 밸런서를 동적으로 생성하는 기능을 제공하는 환경(GCP, AWS등)에서만 사용할 수 있다.
> MetalLB, LBaaS 등과 같은 온프레미스 환경에서도 LoadBalancer 타입의 서비스를 사용할 수 있다.

`hostname-svc-lb.yml` 을 적용

마찬가지로 INTERNAL/EXTERNAL IP를 할당받는다. 이때 EXTERNAL-IP 항목은 클라우드 플랫폼으로부터 자동으로 할당받은 것이며, 이 주소와 80포트(yml파일의 ports.port)를 통해 파드에 접근할 수 있다.

1. LoadBalancer 타입의 서비스가 생성됨과 동시에 모든 워커 노드는 파드에 접근할 수 있는 랜덤한 포트를 개방한다. 
2. 클라우드 플랫폼에서 생성된 로드 밸런서로 요청이 들어오면 이 요청은 k8s 워커노드 중 하나로 전될며, 이때 사용되는 포트는 1번에서 개방된 포트이다.
3. 워커노드로 전달된 요청은 파드 중 하나로 전달되어 처리된다.

LoadBalancer 타입을 명시해 서비스를 생성했지만, Nodeport 의 간접적인 기능 또한 자동으로 사용할 수 있다.

k8s v1.18.0 기준으로 서비스의 yml 에 아무런 설정을 하지 않으면 AWS의 클래식 로드 밸런서를 생성한다. (원한다면 NLB:Network Load Balancer)를 생성할 수 있다. 


> `hostname-svc-nlb.yml` 적용하면 NLB를 설정할 수 있다.
>
> 이처럼 특정 용도로 사용할 수 있게 k8s에 미리 정의된 몇가지 주석(Annotations)가 있다. 

#### [6.5.4.1] 온프레미스 환경에서 LoadBalancer 타입의 서비스 사용
온프레미스 환경에서도 LoadBalancer 타입을 사용할 수 있다. MetalLB나 오픈스택과 같은 특수한 환경을 직접 구축해야만 한다.

하지만, 이는 k8s에서 정식적으로 지원하는 것이 아니기 때문에 유지보수가 지속적이지 않을 수 있다는 점에 유의해야 한다.

#### [6.5.5.0] 트래픽의 분배를 결정하는 서비스 속성 : externalTrafficPolicy
NordPort 또는 LoadBalancer 타입을 사용하는 경우, 들어온 요청에 따라서 불필요한 밸런싱이 될 수 있다. 즉 이는 다음과 같은 단점을 갖는다.

- 불필요한 네트워크 홉(hop)이 한 단계 더 발생하게 된다.
- 노드 간의 리다이렉트가 발생하게 되어 트래픽의 출발지 주소가 바뀌는 SNAT가 발생한다.
  - 이로인해 Client IP 주소 또한 보존되지 않는다.

이를 위해 k8s 의 서비스에는 `externalTrafficPolicy` 항목이 정의되어 있다.

- `spec.externalTrafficPolicy: Cluster`
  - 클러스터의 모든 노드에 랜덤한 포트를 개방
  - NodePort 와 LoadBalancer 가 기본적으로 동작하는 방식이다.
  - 단, 노드 간에 요청이 리다이렉트 되어 NAT가 발생하므로 Client IP를 보존할 수 없다.
- `spec.externalTrafficPolicy: local`
  - 파드가 생성된 노드에서만 접근할 수 있다.
  - 로드 밸런서는 파드가 위치한 노드로만 요청을 전달, 해당 노드 내의 파드에서만 요청이 분산
  - 추가적인 네트워크 홉이 발생하지 않으며, 전달되는 요청의 Client IP는 보존된다.

그렇지만 `spec.externalTrafficPolicy: local` 을 설정하는 것이 무조건 좋은 것은 아니다. 각 노드에 파드가 고르지 않게 스케줄링됐을 때, 요청이 고르게 분산되지 않을 수도 있기 때문이다.
- 로드밸런서가 N개의 노드에 트래픽을 분배해도, 각 파드가 실제로 받는 부하의 양은 동일하지 않을 수 있기 때문이다.
  
> k8s 의 `PodAntiAffinity` 를 통해 최대한 클러스터 노드에 고르게 배포할 수 있다.

#### [6.5.6.0] 요청을 외부로 리다이렉트하는 서비스 : ExternalName
k8s를 외부 시스템과 연동해야 할 때는 `ExternalName` 타입의 서비스를 사용할 수 있다.

이를 사용하여 서비스를 생성하면 서비스가 외부 도메인을 가리키도록 설정할 수 있다.

`external-svc.yml` 적용하면, externalname-svc라는 이름으로 요청을 보낼 경우, k8s의 DNS는 my.database.com 으로 접근할 수 있도록 CNAME 레코드를 반환한다. 
즉, external-svc로 요청을 보내면 my.database.com 에 접근하게 된다.

> DNS 레코드 종류 중 `CNAME 레코드` 는 Canonical Name의 줄임말로, 도메인을 가리키는 다른 이름을 뜻한다. 비슷한 레코드로는 `A레코드` 가 있다. 이는 도메인이름이 직접 IP로 변환되는 경우를 말한다.
>
> | 사용하는 도메인 이름 | 변환되는 주소|
> |---|---|
> | externalname-svc (CNAME 레코드) | my.database.com |
> | hostname-svc-nodeport | 10.110.9.251 |
